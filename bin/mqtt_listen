#!/usr/bin/env bash

if [[ $# -gt 1 || "$*" = "help" || "$*" = "-h" || "$*" = "--help" ]]; then
cat << EOF
Syntax: mqtt_listen [topic_or_subtopic]

mqtt_listen subscribes to a topic and all its subtopics via mqtt and prints
the received messages.

If mqtt_listen is called from a node directory, the root topic is automatically
based on the node's main topic and the given subtopic is prefixed with it.
Also the system.node is taken into account for other MQTT settings.
To send to the node's main topic, give "" as topic.
If topic starts with / the node main topic is ignored.
EOF
exit 1
fi

[ "$ULNOIOT_ACTIVE" = "yes" ] || { echo "ulnoiot not active, aborting." 1>&2;exit 1; }

if [[ -e "node.conf" || -e "../node.conf" ]]; then  # started from node-directory
    source "$ULNOIOT_ROOT/bin/read_config"
else # Check if in system directory and read
    source "system.conf" &> /dev/null
fi

if [[ "$1" = "/"* ]]; then
    topic="${1:1}"
else
    if [[ "$1" ]]; then
        if [[ "$topic" ]]; then
            topic="$topic/$1"
        else
            topic="$1"
        fi
    fi
fi

if [[ "$topic" ]]; then
    topic="$topic/#"
else
    topic="#"
fi

echo "Subscribing and listening to mqtt://$ULNOIOT_MQTT_HOST/$topic." >&2
mosquitto_sub -v -h "$ULNOIOT_MQTT_HOST" -t "$topic"
